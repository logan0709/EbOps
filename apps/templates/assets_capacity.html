{% extends 'base.html' %}
{% block content %}
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>
                        系统容量
                    </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">

                    <div class="uc pull-left m-r-5">
                        <a class="btn btn-sm btn-primary" id="check_nodes" href="{{ url_for('assets.create_capacity_info') }}"> 添加 </a>
                    </div>
                    <div class="" style="float: right">
                       <div class=" btn-group">
                            <button data-toggle="dropdown" class="btn btn-default btn-sm dropdown-toggle">EXCEL <span class="caret"></span></button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class=" btn_export" tabindex="0">
                                    <span>导出</span>
                                    </a>
                                </li>
                                <li>
                                    <a class=" btn_import" data-toggle="modal" data-target="#import_modal" tabindex="0">
                                    <span>导入</span>
                                    </a>
                                </li>
                            </ul>
                       </div>
                    </div>
                    <div id="capacity_list_table_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                        <div id="uc1" class="pull-left"></div>
                        <div id="asset_list_table_filter" class="dataTables_filter">
                               <select class="btn btn-default btn-sm m-b" style="width: auto" id="slct_bulk_update">
                                    <option value="null">选择类型</option>
                                       {% for p in platform %}
                                       <option value="{{ p }}">{{ p }}</option>
                                       {% endfor %}
                               </select>
                        </div>
                        <table class="table table-striped table-bordered table-hover dataTable no-footer" id="asset_list_table" role="grid">
                        <thead>
                            <tr role="row">
                                <th class="text-center sorting_disabled" rowspan="1" colspan="1" aria-label="" style="width: 3%;">ID</th>
                                <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 15%;" >类别</th>
                                <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 20%;" >网元名称</th>
                                <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 15%;" >软件容量</th>
                                <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 15%;" >硬件容量</th>
                                <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 15%;" >网元状态</th>
<!--                                <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 15%;" >备注</th>-->
                                <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 10%;" >动作</th>
                            </tr>
                        </thead>
                        <tbody id="capacity_tab">
                        {% for c_item in datas %}
                                <tr role="row" class="odd">
                                <td class=" text-center">{{ c_item.id }}</td>
                                <td class=" text-center">{{ c_item.platform }}</td>
                                <td class=" text-center">{{ c_item.cluster }}</td>
                                <td class=" text-center">{{ c_item.s_capacity }}</td>
                                <td class=" text-center">{{ c_item.h_capacity }}</td>
                                <td class=" text-center">{{ c_item.status }}</td>
<!--                                <td class=" text-center">{{ c_item.info }}</td>-->
                                <td class=" text-center">
                                    <button type="button" class="btn btn-info btn-xs" data-toggle="modal" data-target="#myModal" data-whatever="{{ c_item.id }}">更新</button>
                                    <button type="button" class="btn btn-danger btn-xs" data-toggle="modal" data-target="#myDelModal" data-whatever="{{ c_item.id }}">删除</button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">更新</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" id="UserUpdateForm">

            <div class="form-group">
                <label class="col-sm-2 control-label">类别</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="platform" name="platform">
                </div>
            </div>

            <div class="form-group required">
                <label class="col-sm-2 control-label">网元名称</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="cluster" name="cluster">
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">软件容量</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="s_capacity" name="s_capacity">
                </div>
            </div>

            <div class="form-group required">
                <label class="col-sm-2 control-label">硬件容量</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="h_capacity" name="h_capacity">
                </div>
            </div>

            <div class="form-group ">
                <label class="col-sm-2 control-label">状态</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="status" name="status">
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">备注</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="info" name="info">
                </div>
            </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="SAVE" data-dismiss="modal">保存</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myDelModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-body">
        确定删除
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">否</button>
        <button type="button" class="btn btn-primary" id="DEL" data-dismiss="modal">是</button>
      </div>
    </div>
  </div>
</div>

<div aria-hidden="true" role="dialog" id="import_modal" class="modal inmodal">
    <div class="modal-dialog ">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button data-dismiss="modal" id="close_button1" class="close close_btn1 " type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">导入信息</h4>
                <small></small>
            </div>

            <div class="modal-body">

    <form method="post" id="fm_import">
        <div class="form-group">
            <label class="control-label">下载导入的模板或使用导出的xlsx格式</label>
            <a href="/assets/down_templates/capacity_data.xlsx" style="display: block">下载导入模版</a>
        </div>

        <div class="form-group">
            <label class="control-label" for="id_file">请选择Excel文件导入</label>
            <input id="id_file" type="file" name="file">
        </div>
    </form>

    <div>
        <p class="text-success" id="success_created"></p>
        <p id="success_created_detail"></p>
        <p class="text-danger" id="created_failed"></p>
        <p id="created_failed_detail"></p>
    </div>

            </div>
            <div class="modal-footer">

              <button id="close_button2" data-dismiss="modal" class="btn btn-white close_btn2" type="button">关闭</button>
              <button class="btn btn-primary" type="button" id="btn_import_confirm">确认</button>

            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    $('#myDelModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var id_no = button.data('whatever');
        var modal = $(this);
        modal.find('#DEL').attr("value",id_no);
    });

    $("#DEL").click(function () {
        var item_id = this.value;
        $.ajax({
            url: "{{ url_for('assets.delete_capacity_info') }}",
            type: "post",
            data: {"id":item_id},
            success:function(data) {
                if(data["flag"]==="success"){
                    location.reload();
                    toastr.info("删除成功.请刷新页面");
                }
                else toastr.error("删除失败");
            }
        });
    });


    $('#myModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var id_no = button.data('whatever');
        var modal = $(this);
        modal.find('.modal-title').text(id_no);
        $.ajax({   //2、发送给后端
            url: "{{ url_for('assets.get_capacity_info') }}",
            type: 'POST',
            data: {"id": id_no},
            success:function(data) {
                if(data["flag"]==="success"){
                    var obj = data["item_info"];
                    modal.find('.modal-body #platform').val(obj.platform);
                    modal.find('.modal-body #cluster').val(obj.cluster);
                    modal.find('.modal-body #s_capacity').val(obj.s_capacity);
                    modal.find('.modal-body #h_capacity').val(obj.h_capacity);
                    modal.find('.modal-body #status').val(obj.status);
                    modal.find('.modal-body #info').val(obj.info);
                }
                else alert("查询失败")

            }
        });

    });

    $("#SAVE").click(function () {
        var item_id = $(".modal-title").text();
        var formSerial = {};
        formSerial["id"] = item_id;
		 $($("#UserUpdateForm").serializeArray()).each(function(){
		    formSerial[this.name] = this.value;
		 });
        $.ajax({
            url: "{{ url_for('assets.modify_capacity_info') }}",
            type: "post",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(formSerial),
            dataType: "json",
            success:function(data) {
                if(data["flag"]==="success"){
                    toastr.info("修改成功.请刷新页面");
                }
                else toastr.error("修改失败");
            }
        });
    });

    $("#slct_bulk_update").change(function() {
        var checkText = $("#slct_bulk_update").find("option:selected").text();
        if(checkText!=="选择类型") {
            $.ajax({
                url: "{{ url_for('assets.capacity') }}",
                type: "post",
                data: {"platform": checkText},
                success:function(data) {
                if(data["flag"]==="success"){
                   $("#capacity_tab").empty();
                   $.each(data["datas"], function (i, n) {
                       var tbBody = "";
                       tbBody += "<tr role=\"row\" >" +
                           "<td class=\" text-center\">" + n.id  + "</td>\n" +
                           "<td class=\" text-center\">" + n.platform  + "</td>\n" +
                           "<td class=\" text-center\">" + n.cluster  + "</td>\n" +
                           "<td class=\" text-center\">" + n.s_capacity  + "</td>\n" +
                           "<td class=\" text-center\">" + n.h_capacity  + "</td>\n" +
                           "<td class=\" text-center\">" + n.status  + "</td>\n" +
                           "<td class=\" text-center\">\n" +
                           "<button type=\"button\" class=\"btn btn-info btn-xs\" data-toggle=\"modal\" data-target=\"#myModal\" data-whatever=\""+n.id + "\">更新</button>" +
                           "<button type=\"button\" class=\"btn btn-danger btn-xs\" data-toggle=\"modal\" data-target=\"#myDelModal\" data-whatever=\""+ n.id + "\">删除</button>" +
                           "</td>\n" +
                           "</tr>";
                       $("#capacity_tab").append(tbBody);
                   })

                }
                else toastr.error("查询失败");
                }
            });
        }

    });

    $("#btn_import_confirm").click(function (){
    var file = document.getElementById('id_file').files[0];
    if(!file){
        toastr.error("选择文件");
        return
    }
    var formFile = new FormData();
    formFile.append("file", file); //加入文件对象
    $.ajax({
        url: "{{ url_for('assets.ca_import') }}",
        type: "post",
        data: formFile,
        processData: false,
        contentType: false,
        success:function(data) {
        if(data["flag"]==="success"){
          toastr.info(data["msg"]);
        }
        else toastr.error(data["msg"]);
        }
      });
    });

    //导出
    $(".btn_export").click(function () {
        var set = [];
        $('#asset_list_table').find('tr').each(function() {
            var row = [];
            $(this).find('th,td').each(function() {
                row.push($(this).text().trim());
            });
            set.push(row);
            });
        $.ajax({
            url: "{{ url_for('assets.unload_excel') }}",
            type: "post",
            data: {"data":JSON.stringify(set)},
            success:function(data) {
                if(data["flag"]==="success"){
                     window.open('/assets/download/'+data['file'], '_self');
                }
                else toastr.error("导出失败");
            }
        });
    })


</script>
{% endblock %}