{% extends 'base.html' %}
{% block content %}
<div class="wrapper wrapper-content animated fadeInRight">

    <div class="ibox">
        <div class="ibox-title">
            <h5>待处理</h5><span class="label label-primary">{{ result|length }}</span>
            <div class="ibox-tools">
                <a href="{{ url_for('operate.task_todo') }}" class="btn btn-default btn-xs">刷新</a>
                <a href="{{ url_for('operate.task_create') }}" class="btn btn-primary btn-xs">新建审批</a>
            </div>
        </div>
        <div class="ibox-content">
<!--            <div class="row m-b-sm m-t-sm">-->
<!--                <div class="col-md-1">-->
<!--                    <button type="button" id="loading-example-btn" class="btn btn-white btn-sm"><i class="fa fa-refresh"></i> Refresh</button>-->
<!--                </div>-->
<!--                <div class="col-md-11">-->
<!--                    <div class="input-group"><input type="text" placeholder="Search" class="input-sm form-control"> <span class="input-group-btn">-->
<!--                        <button type="button" class="btn btn-sm btn-primary"> Go!</button> </span></div>-->
<!--                </div>-->
<!--            </div>-->

            <div class="project-list">

                <table class="table table-hover">
                    <tbody>
                    {% for op in result %}
                    <tr>
                        <td class="project-title">
                            {{ op.id }}
                        </td>
                        <td class="project-status">
                            {% if op.opStatus == "Created" %}
                            <span class="label label-warning">待内审</span>
                            {% elif op.opStatus == "apply" %}
                            <span class="label label-danger">待局审</span>
                            {% elif op.opStatus == "permit" %}
                            <span class="label label-success">待操作</span>
                            {% elif op.opStatus == "finish" %}
                            <span class="label label-default">已完成</span>
                            {% endif %}
                        </td>
                        <td class="project-title">
                            <a href="/operate/detail/{{ op.id }}">{{ op.opSubject }}</a>
<!--                            <br>-->
<!--                            <small>Created   {{ op.opCreateDate }}</small>-->
                        </td>
<!--                        <td class="project-title">-->
<!--                            {{ op.opSubsystem }}-->
<!--                        </td>-->
                        <td class="project-title">
                            <strong>{{ op.opCreator }}</strong>
                            <br>
                            <small>Created   {{ op.opCreateDate }}</small>
                        </td>
                        <td class="project-completion">
                            {% if op.opStatus == "Created" %}
                                <small>当前进度: 20%</small>
                                <div class="progress progress-mini">
                                <div style="width: 20%;" class="progress-bar"></div>
                                </div>
                            {% elif op.opStatus == "apply" %}
                               <small>当前进度: 40%</small>
                                <div class="progress progress-mini">
                                <div style="width: 40%;" class="progress-bar"></div>
                                </div>
                            {% elif op.opStatus == "permit" %}
                                <small>当前进度: 60%</small>
                                <div class="progress progress-mini">
                                <div style="width: 60%;" class="progress-bar"></div>
                                </div>
                            {% elif op.opStatus == "finish" %}
                               <small>当前进度: 100%</small>
                                <div class="progress progress-mini">
                                <div style="width: 100%;" class="progress-bar"></div>
                                </div>
                            {% endif %}
                        </td>

                        <td class="project-actions">
                            {% if current_user.is_admin %}
                            {% if op.opStatus == "Created" %}
                            <button  class="btn btn-white btn-sm" value="{{ op.id }}|apply" onclick="task_action(this.value)"><i class="fa fa-check-square-o"></i> 内部审核 </button>
                            {% elif op.opStatus == "apply" %}
                            <button  class="btn btn-white btn-sm" data-toggle="modal" data-target="#permitModal" data-whatever="{{ op.id }}"><i class="fa fa-check-square-o"></i> 局方审核 </button>
                            {% endif %}
                            {% endif %}
                            {% if op.opStatus == "permit" %}
                            <a href="#" class="btn btn-white btn-sm" data-toggle="modal" data-target="#myModal" data-whatever="{{ op.id }}"><i class="fa fa-check-square-o"></i>添加结果</a>
                            {% endif %}
                            <a href="#" class="btn btn-white btn-sm" data-toggle="modal" data-target="#myDelModal" data-whatever="{{ op.id }}"><i class="fa fa-times"></i> 删除 </a>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="myDelModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-body">
        确定删除该操作
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">否</button>
        <button type="button" class="btn btn-danger" id="DEL" data-dismiss="modal">是</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">操作主题</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" id="UserUpdateForm">

            <div class="form-group">
                <label class="col-sm-2 control-label">操作结果</label>
                <div class="col-sm-10">
                    <textarea class="form-control" id="opResult" name="opResult"></textarea>
                </div>
            </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="SAVE" data-dismiss="modal">提交</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="permitModal" tabindex="-1" role="dialog" aria-labelledby="permitModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="permitModalLabel">操作主题</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" id="permitForm">

            <div class="form-group">
                <label class="col-sm-5 control-label">局方审批人</label>
                <div class="col-sm-7">
                    <input class="form-control" id="outReviewer" name="outReviewer">
                </div>
            </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="PERMIT" data-dismiss="modal">审批</button>
      </div>
    </div>
  </div>
</div>




<script type="text/javascript">
    function task_action(value){
        $.ajax({
            url: "{{ url_for('operate.task_action') }}",
            type: "post",
            data: {"action": value},
            success: function (data) {
                if (data["flag"] === "success") {
                    location.reload();
                    toastr.info("审批成功");
                } else toastr.error("操作失败");
            }
        });
    }

    // 删除操作审批
    $('#myDelModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var id_no = button.data('whatever');
        var modal = $(this);
        modal.find('#DEL').attr("value",id_no);
    });

	$("#DEL").click(function () {
        var host_id = this.value;
        var action = host_id + "|delete";
        $.ajax({
            url: "{{ url_for('operate.task_action') }}",
            type: "post",
            data: {"action": action},
            success:function(data) {
                if(data["flag"]==="success"){
                    location.reload();
                    toastr.info("删除成功");
                }
                else toastr.error("删除失败");
            }
        });
    });

	//添加操作结果
    $('#myModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var id_no = button.data('whatever');
        var modal = $(this);
        modal.find('.modal-title').text(id_no);
    });

    $("#SAVE").click(function () {
        var item_id = $("#myModalLabel").text();
        var formData  = new FormData();
        formData.append("action", item_id+"|finish");
        formData.append("opResult", $("#opResult").val());
        $.ajax({
            url: "{{ url_for('operate.task_action') }}",
            type: "POST",
            data: formData,
            async: false,
            contentType: false,
            processData: false,
            success:function(data) {
                if(data["flag"]==="success"){
                    location.reload();
                    toastr.info("保存成功");
                }
                else toastr.error("保存失败");
            }
        });
    });

    	//添加局方审批人
    $('#permitModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var id_no = button.data('whatever');
        var modal = $(this);
        modal.find('.modal-title').text(id_no);
    });

    $("#PERMIT").click(function () {
        var item_id = $("#permitModalLabel").text();
        var formData  = new FormData();
        formData.append("action", item_id+"|permit");
        formData.append("outReviewer", $("#outReviewer").val());
        $.ajax({
            url: "{{ url_for('operate.task_action') }}",
            type: "POST",
            data: formData,
            async: false,
            contentType: false,
            processData: false,
            success:function(data) {
                if(data["flag"]==="success"){
                    location.reload();
                    toastr.info("审批通过");
                }
                else toastr.error("操作失败");
            }
        });
    });

</script>

{% endblock %}
